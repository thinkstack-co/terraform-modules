###############
# TEST MODULE
###############

module "aws_backup" {
  source = "github.com/thinkstack-co/terraform-modules//modules/thinkstack/aws_backup/backup_custom?ref=dev-backups"
  providers = {
    aws.aws_prod_region = aws.aws_prod_region
    aws.aws_dr_region   = aws.aws_dr_region
  }

  backup_jobs = [
    {
      provider       = aws.aws_dr_region
      vault_name     = "instance_1",
      rule_name      = "daily-backup",
      schedule       = "cron(0 12 * * ? *)",
      selection_tag  = "instance_1",
      dr_region      = true
      retention_days = 30,
      vault_tags = {
        Environment = "Dev/Sandbox"
        Project     = "Backup Management"
      }
    },
    {
      provider       = aws.aws_prod_region
      vault_name     = "instance_2",
      rule_name      = "weekly-backup",
      schedule       = "cron(0 0 ? * SUN *)",
      selection_tag  = "instance_2",
      dr_region      = false
      retention_days = 90,
      vault_tags = {
        Environment = "Dev/Sandbox"
        Project     = "Backup Management 2"
      }
    }
  ]
  key_bypass_policy_lockout_safety_check = true
  key_customer_master_key_spec           = "SYMMETRIC_DEFAULT"
  key_description                        = "AWS backups kms key used to encrypt backups"
  key_deletion_window_in_days            = 30
  key_enable_key_rotation                = true
  key_usage                              = "ENCRYPT_DECRYPT"
  key_is_enabled                         = true
  key_name                               = "alias/aws_backup_key"
  key_policy                             = null
}
